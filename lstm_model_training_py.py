# -*- coding: utf-8 -*-
"""lstm_model_training.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NOH3Hm-0akW0PUnUy0guv2eL9tr7MAwu
"""

# Import libraries
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.preprocessing import MinMaxScaler
from sklearn.metrics import mean_squared_error, mean_absolute_error, r2_score
import tensorflow as tf
from tensorflow import keras
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout, SimpleRNN, GRU
from tensorflow.keras.callbacks import EarlyStopping, ModelCheckpoint
import pickle
import warnings
warnings.filterwarnings('ignore')

print("TensorFlow version:", tf.__version__)

# ============================================
# 1. LOAD CLEANED DATA
# ============================================

# Upload cleaned data
from google.colab import files
print("Upload google_stock_cleaned.csv file...")
uploaded = files.upload()

df = pd.read_csv('google_stock_cleaned.csv')
df['Date'] = pd.to_datetime(df['Date'])
print(f"Data loaded: {len(df)} rows")
print(df.head())

# ============================================
# 2. PREPARE DATA FOR LSTM
# ============================================

# Use Close price for prediction
data = df['Close'].values.reshape(-1, 1)

# Normalize data
scaler = MinMaxScaler(feature_range=(0, 1))
scaled_data = scaler.fit_transform(data)

# Save scaler for later use
with open('scaler.pkl', 'wb') as f:
    pickle.dump(scaler, f)

# Create sequences
def create_sequences(data, seq_length):
    X, y = [], []
    for i in range(seq_length, len(data)):
        X.append(data[i-seq_length:i, 0])
        y.append(data[i, 0])
    return np.array(X), np.array(y)

# Set sequence length (60 days)
SEQ_LENGTH = 60

X, y = create_sequences(scaled_data, SEQ_LENGTH)

# Split data: 80% train, 20% test
train_size = int(len(X) * 0.8)
X_train, X_test = X[:train_size], X[train_size:]
y_train, y_test = y[:train_size], y[train_size:]

# Reshape for LSTM [samples, time steps, features]
X_train = X_train.reshape(X_train.shape[0], X_train.shape[1], 1)
X_test = X_test.reshape(X_test.shape[0], X_test.shape[1], 1)

print(f"\nTraining samples: {X_train.shape[0]}")
print(f"Testing samples: {X_test.shape[0]}")
print(f"Sequence length: {SEQ_LENGTH}")

#============================================
# 3. BUILD LSTM MODEL
# ============================================

def build_lstm_model(input_shape):
    model = Sequential([
        LSTM(128, return_sequences=True, input_shape=input_shape),
        Dropout(0.2),
        LSTM(64, return_sequences=True),
        Dropout(0.2),
        LSTM(32, return_sequences=False),
        Dropout(0.2),
        Dense(25),
        Dense(1)
    ])
    model.compile(optimizer='adam', loss='mean_squared_error', metrics=['mae'])
    return model

# ============================================
# 4. BUILD RNN MODEL (for comparison)
# ============================================

def build_rnn_model(input_shape):
    model = Sequential([
        SimpleRNN(128, return_sequences=True, input_shape=input_shape),
        Dropout(0.2),
        SimpleRNN(64, return_sequences=True),
        Dropout(0.2),
        SimpleRNN(32, return_sequences=False),
        Dropout(0.2),
        Dense(25),
        Dense(1)
    ])
    model.compile(optimizer='adam', loss='mean_squared_error', metrics=['mae'])
    return model

# ============================================
# 5. BUILD GRU MODEL (for comparison)
# ============================================

def build_gru_model(input_shape):
    model = Sequential([
        GRU(128, return_sequences=True, input_shape=input_shape),
        Dropout(0.2),
        GRU(64, return_sequences=True),
        Dropout(0.2),
        GRU(32, return_sequences=False),
        Dropout(0.2),
        Dense(25),
        Dense(1)
    ])
    model.compile(optimizer='adam', loss='mean_squared_error', metrics=['mae'])
    return model

# ============================================
# 6. TRAIN MODELS
# ============================================

input_shape = (X_train.shape[1], 1)

# Callbacks
early_stop = EarlyStopping(monitor='val_loss', patience=10, restore_best_weights=True)

print("\n" + "="*80)
print("TRAINING LSTM MODEL")
print("="*80)

lstm_model = build_lstm_model(input_shape)
print(lstm_model.summary())

history_lstm = lstm_model.fit(
    X_train, y_train,
    epochs=50,
    batch_size=32,
    validation_split=0.1,
    callbacks=[early_stop],
    verbose=1
)

# Save LSTM model
lstm_model.save('lstm_model.h5')
print("LSTM model saved!")

print("\n" + "="*80)
print("TRAINING RNN MODEL")
print("="*80)

rnn_model = build_rnn_model(input_shape)
history_rnn = rnn_model.fit(
    X_train, y_train,
    epochs=50,
    batch_size=32,
    validation_split=0.1,
    callbacks=[early_stop],
    verbose=1
)

rnn_model.save('rnn_model.h5')
print("RNN model saved!")

print("\n" + "="*80)
print("TRAINING GRU MODEL")
print("="*80)

gru_model = build_gru_model(input_shape)
history_gru = gru_model.fit(
    X_train, y_train,
    epochs=50,
    batch_size=32,
    validation_split=0.1,
    callbacks=[early_stop],
    verbose=1
)

gru_model.save('gru_model.h5')
print("GRU model saved!")

# ============================================
# 7. PLOT TRAINING HISTORY
# ============================================

fig, axes = plt.subplots(1, 3, figsize=(18, 5))

# LSTM
axes[0].plot(history_lstm.history['loss'], label='Train Loss', linewidth=2)
axes[0].plot(history_lstm.history['val_loss'], label='Val Loss', linewidth=2)
axes[0].set_title('LSTM Training History', fontsize=14, fontweight='bold')
axes[0].set_xlabel('Epoch')
axes[0].set_ylabel('Loss')
axes[0].legend()
axes[0].grid(True, alpha=0.3)

# RNN
axes[1].plot(history_rnn.history['loss'], label='Train Loss', linewidth=2)
axes[1].plot(history_rnn.history['val_loss'], label='Val Loss', linewidth=2)
axes[1].set_title('RNN Training History', fontsize=14, fontweight='bold')
axes[1].set_xlabel('Epoch')
axes[1].set_ylabel('Loss')
axes[1].legend()
axes[1].grid(True, alpha=0.3)

# GRU
axes[2].plot(history_gru.history['loss'], label='Train Loss', linewidth=2)
axes[2].plot(history_gru.history['val_loss'], label='Val Loss', linewidth=2)
axes[2].set_title('GRU Training History', fontsize=14, fontweight='bold')
axes[2].set_xlabel('Epoch')
axes[2].set_ylabel('Loss')
axes[2].legend()
axes[2].grid(True, alpha=0.3)

plt.tight_layout()
plt.show()

# ============================================
# 8. EVALUATE MODELS
# ============================================

def evaluate_model(model, X_test, y_test, model_name):
    predictions = model.predict(X_test)

    # Inverse transform
    predictions = scaler.inverse_transform(predictions)
    y_test_actual = scaler.inverse_transform(y_test.reshape(-1, 1))

    # Calculate metrics
    mse = mean_squared_error(y_test_actual, predictions)
    rmse = np.sqrt(mse)
    mae = mean_absolute_error(y_test_actual, predictions)
    r2 = r2_score(y_test_actual, predictions)
    mape = np.mean(np.abs((y_test_actual - predictions) / y_test_actual)) * 100

    print(f"\n{model_name} MODEL PERFORMANCE:")
    print("="*50)
    print(f"MSE:  {mse:.4f}")
    print(f"RMSE: {rmse:.4f}")
    print(f"MAE:  {mae:.4f}")
    print(f"RÂ²:   {r2:.4f}")
    print(f"MAPE: {mape:.2f}%")
    print("="*50)

    return predictions, y_test_actual

print("\n" + "="*80)
print("MODEL EVALUATION")
print("="*80)

lstm_pred, y_actual = evaluate_model(lstm_model, X_test, y_test, "LSTM")
rnn_pred, _ = evaluate_model(rnn_model, X_test, y_test, "RNN")
gru_pred, _ = evaluate_model(gru_model, X_test, y_test, "GRU")

# ============================================
# 9. VISUALIZE PREDICTIONS
# ============================================

plt.figure(figsize=(16, 10))

plt.subplot(3, 1, 1)
plt.plot(y_actual, label='Actual Price', linewidth=2, color='black')
plt.plot(lstm_pred, label='LSTM Predicted', linewidth=2, color='blue', alpha=0.7)
plt.title('LSTM Predictions vs Actual', fontsize=14, fontweight='bold')
plt.xlabel('Time')
plt.ylabel('Price (USD)')
plt.legend()
plt.grid(True, alpha=0.3)

plt.subplot(3, 1, 2)
plt.plot(y_actual, label='Actual Price', linewidth=2, color='black')
plt.plot(rnn_pred, label='RNN Predicted', linewidth=2, color='green', alpha=0.7)
plt.title('RNN Predictions vs Actual', fontsize=14, fontweight='bold')
plt.xlabel('Time')
plt.ylabel('Price (USD)')
plt.legend()
plt.grid(True, alpha=0.3)

plt.subplot(3, 1, 3)
plt.plot(y_actual, label='Actual Price', linewidth=2, color='black')
plt.plot(gru_pred, label='GRU Predicted', linewidth=2, color='red', alpha=0.7)
plt.title('GRU Predictions vs Actual', fontsize=14, fontweight='bold')
plt.xlabel('Time')
plt.ylabel('Price (USD)')
plt.legend()
plt.grid(True, alpha=0.3)

plt.tight_layout()
plt.show()

# Comparison plot
plt.figure(figsize=(15, 6))
plt.plot(y_actual, label='Actual Price', linewidth=3, color='black')
plt.plot(lstm_pred, label='LSTM', linewidth=2, alpha=0.7)
plt.plot(rnn_pred, label='RNN', linewidth=2, alpha=0.7)
plt.plot(gru_pred, label='GRU', linewidth=2, alpha=0.7)
plt.title('All Models Comparison', fontsize=16, fontweight='bold')
plt.xlabel('Time', fontsize=12)
plt.ylabel('Price (USD)', fontsize=12)
plt.legend(fontsize=12)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()

# ============================================
# 10. DOWNLOAD FILES
# ============================================

print("\n" + "="*80)
print("DOWNLOADING MODEL FILES...")
print("="*80)

files.download('lstm_model.h5')
files.download('rnn_model.h5')
files.download('gru_model.h5')
files.download('scaler.pkl')

print("\n All files downloaded! You'll need these for the interface.")